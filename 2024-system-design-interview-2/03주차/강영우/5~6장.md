# 5~6장

# 5장. 지표 모니터링 및 경보 시스템

## 1. 요구사항

- 기능
    - 지표수집이 되어야 함
        - 데이터는 시간이 지나며 1분단위 / 1시간 단위 등으로 해상도를 낮추며 1년간 저장
    - 특정 임계치에 다다르면 경보를 보낼 수 있어야 함(웹, 단문 메시지, 알림 등)
    - 시각화 할 줄 알아야 함
- 비기능
    - 대규모 시스템을 커버할 수 있어야 함(사용자 1억명 이상)
    - 중요 경보를 누락하면 안된다.
    - 스케일 인/아웃, 컴포넌트의 변경에도 유연해야 한다.

## 2. 설계

### 다섯 컴포넌트

- 데이터 수집: 원본 대상으로부터 데이터를 수집
    - 풀모델 / 푸시 모델: 장단점이 달라서 잘 사용해야 한다.
        - 풀모델은 수집 컴포넌트가 특정 엔드포인트를 통해 수집하고자 하는 대상의 정보를 당겨오는 것.
        - 푸시모델은 각 수집대상의 에이전트가 주기적으로 수집 컴포넌트에 지표정보를 전송하는 것.
- 데이터 전송: 데이터를 DB로 전송
    - 카프카를 이용해서 안정적으로 전송하는 방법
    - 카프카를 이용하지 않으면 고릴라같은 고가용성 데이터베이스를 사용하면 된다.
    - 데이터 질의
        - 질의 시 언제 질의할 것인지도 고려대상임
        - 데이터 파이프라인 내에서 미리 생성
        - 데이터 조회 시에 바로 집계
- 데이터 저장: 시계열 데이터를 저장하는 데이터베이스
    - 막대한 쓰기와 간헐적 높은 읽기 연산 부하를 생각해서 고를 것. (프로메테우스)
    - 저장용량 최적화
        - 다운샘플링: 예를 들어 1분단위의 데이터 60개를 1시간 단위의 데이터 1개로 줄이는 것.
        - 데이터 인코딩 및 압축: 시계열 데이터이므로 타임스탬프를 기준으로 간극만 보내는 것.
        - 냉동 저장소: S3같은 싸고 영속성이 보장되는 곳에 시간이 오래 지난 데이터들을 모아서 쌓아두는 곳
- 경보: 지표에 따라 임계치를 위반하면 설정해둔 경로로 경보 전송
    - 임계치를 설정해둔 yaml 파일을 읽어서 위반하면 경보를 울린다.
    - 구현하는 것보다 시중에 나와있는게 더 나음
- 시각화: 지표를 본다
    - 직접 구현하기 어려우니까 그라파나 같은 것 사용하기

# 6장. 광고 클릭 이벤트 집계

## 1. 요구사항

- 기능
    - 클릭 수 집계 가능해야 함
    - 상위 N개 광고 조회 가능해야 함
    - 특정 필드를 기준으로 필터링 할 수 있어야 함
- 비기능
    - 최대한 무결성 보장
    - 이벤트가 늦게와도 결국엔 조회가 가능해야 함
    - 안정성 있어야 함
- 추정치
    - 10억 광고 클릭
    - 최대 50,000 QPS
    - 일간 저장 공간 예상: 100GB

## 2. 설계

- 질의 API
    - 일반 광고 로그 조회
        - 쿼리 파라미터로 특정 필드 필터링 및 기간 조회
    - 상위 N개 광고 조회
- 데이터 모델
    - 원시데이터
        - 저장해야함. 나중에 언제 쓸지 몰라서. 데이터는 크다.
    - 집계데이터
        - 저장해야함. 읽기 부하를 줄이기 위해서.
    - 데이터베이스
        - 카산드라같은 것 사용해야 함 (쓰기 부하를 굉장히 많이 받기 때문에)
- 비동기 처리
    - 엄청난 이벤트를 한번에 처리하면 병목이 발생할 수 있으므로 카프카를 이용한 비동기 처리
- 맵리듀스
    - DAG를 이용해 각 단계/노드를 설계해서 확장/변경에 유용하도록 집계를 처리해야 함
- 집계 윈도우
    - 텀블링 윈도우 또는 슬라이드 윈도우 사용
    - 여기에 버퍼시간을 둬서 늦게 도착한 이벤트도 사용 가능하도록 운영
        - 버퍼시간을 너무 늦게하면 집계 정확성은 올라가지만 반대로 조회시에 시간 오프셋이 길어질 수 있음
- 카파 아키텍처
    - 스트림 처리, 일괄처리 둘다 사용
    - 스트림 처리
        - 입력 데이터를 받아서 실시간으로 집계 결과 생성
    - 일괄 처리
        - 이력 데이터를 백업하기 위해 사용
- 전달 보증을 하기 위해서 S3같은 곳에 오프셋 스냅샷을 저장해서 사용해야 함
- 모니터링
    - 지연시간 / 메시지 큐 크기 / 집계노드의 시스템 자원을 추적해야 함