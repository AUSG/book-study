# 5. 지표 모니터링 및 경보 시스템

-   이 시스템은 5개의 컴포넌트로 이루어져있음
    -   데이터 수집
    -   데이터 전송
    -   데이터 저장소
    -   경보
    -   시각화
-   데이터 모델은 시계열 데이터 모델을 사용하며, 시계열 데이터 모델은 타임스탬를 붙인 형태로 저장한다는 것을 의미
-   보통 지표 모니터링 시스템의 데이터는 쓰기가 압도적으로 높은 모델임. 읽기는 특정 타이밍에 잠시 급증하는 형식
-   데이터 저장소 시스템
    -   일반적인 RDBMS는 적합하지 않음. 지수 이동 평균 값등을 쿼리하는 걸 직접 구현해야 함.
    -   NoSQL은 카산드라나 빅테이블 같은걸 사용할 수 있지만 이것도 이해도가 높아야 함. 
    -   그래서 보통 InfluxDB, 프로메테우스 등의 시계열 데이터베이스를 사용
-   시스템은 지표 출처로부터 지표를 수집기가 수집하고 시계열 데이터베이스에 저장한 뒤 질의 시스템이 질의하는 방식임.
    -   시각화 시스템 혹은 경보시스템은 질의 시스템을 통해서 질의하고, 경보시스템은 질의 결과 기반으로 경보를 날림.
-   지표 수집에서 Pull vs Push
    -   둘 다 많이 사용 됨. 적재적소에 쓰면 될 듯
    -   풀 모델
        -   서비스 디스커버리등을 기반으로 지표 출처에 직접 메트릭 엔드포인트에 질의하는 형태
        -   보통 수집기도 여러 대로 이루어져있는데, 이 메커니즘에서 수집기가 어느 곳으로 질의할지는 안정해시 기반으로 선택하게 됨.
    -   푸시모델
        -   푸시 모델은 해당 서버가 지표 수집기로 지표를 전달하는 형태
        -   보통 에이전트를 서버에 달고 그 에이전트가 지표를 수집기에 전송함
        -   지표 수집기가 많은 지표를 처리하지 못하는 것을 방지하기 위해 클러스터 자체도 자동 규모 확장이 가능하도록 구성하고 앞에 로드밸런서를 두는 것이 바람직 함
        -   핀포인트 같은 애들이 jvm agent 달고 실행되니 얘네들은 푸시모델이 아닐까?
-   지표 전송 파이프라인 규모 확장
    -   지표 수지깁기는 엄청난 양의 데이터를 받아 처리하고, 이것을 받는 시계열 데이터베이스에 장애가 생기면 손실이 발생할 가능성이 존재한다. 
    -   이걸 카프카와 같은 메시지 큐를 두는 방식으로 결합도를 낮추고, 장애가 발생해도 메시지가 소실되지 않도록 할 수 있음.
-   카프카를 통한 규모 확장
    -   카프카에 내장된 파티션 메커니즘을 통한 확장
    -   대역폭에 따라 파티션의 수를 설정하고, 우선순위를 지정
-   질의 서비스에 캐시 계층을 두는 방식으로 질의 부하를 낮추고 질의 서비스의 성능을 높일 수 있음
-   저장은 데이터를 인코딩하고 압축하는 방식으로 용량을 최적화할 수 있으며, 다운 샘플링을 통해서도 이루어낼 수 있음



# 6. 광고 클릭 이벤트 집계

-   실시간 경매는 디지털 광고의 핵심프로세스임
    -   보통 실시간 경매는 1초내에 모두 다 이루어지기에 속도가 중요한 지표 중 하나
-   시스템에서는 원시 데이터와 집계 결과 데이터를 다루며, 집계 결과 데이터는 원시 데이터를 가공한 형태
    -   둘 다 저장하는 것이 좋음 ( 추후 디버깅을 위해 원시데이터를, 질의를 위해 집계결과데이터를 저장 )
-   원시 데이터는 QPS를 위해 카산드라를 사용
-   집계 데이터는 시계열 데이터이고, 읽기 및 쓰기 연산을 둘 다 많이 사용함.
-   메시지 큐를 중간에 두는 방식으로 생산자와 소비자의 결합을 끊고 규모를 독립적으로 확장할 수 있도록 함.
-   광고 이벤트를 집계하는데 좋은 방식 중 하나는 맵-리듀스
    -   맵 노드
        -   데이터를 필터링하고 변환
        -   입력데이터를 정리하고 정규화하는데 필요
    -   집계 노드
        -   ad_id 별 클릭 이벤트 수를 메모리에서 집계
        -   리듀스 프로세스의 일부라고 생각해도 됨
    -   리듀스 노드
        -   집계 노드의 산출 결과를 최종 결과로 축약
-   스트리밍 vs 일괄처리
    -   스트리밍과 일괄 처리 모두 사용
    -   스트리밍은 데이터를 집계하고, 일괄처리는 백업에 사용
-   데이터 재계산
    -   집계한 데이터를 다시 계산해야하는 경우 이력 데이터 재처리를 함
-   이벤트 발생시각과 처리시각
    -   발생시각은 클릭 이벤트 발생시각
    -   처리시각은 처리하는 서버에 도착해서 처리되는 시각
    -   발생시각이 정확하지만 이벤트 집계에 늦게 도착하면 이벤트 집계가 부정확할 수 있음
    -   정확도가 중요하기에 발생시각을 사용
-   늦게 도착한 데이터는 워터마크 기법을 사용함
    -   워터마크라는 구간을 추가로 넣으면서 누락될 수 있는 이벤트를 캡쳐함
    -   길어지면 처리할 수 있는 이벤트가 많아지지만, 처리시간이 길어짐
    -   짧으면 정확도는 떨어지지만 응답은 빨라짐
-   집계 윈도우는 아래 4가지 방식이 있으며, 텀블링윈도우와 슬라이딩 윈도우를 알아 볼 것임
    -   텀블링 윈도우 / 고정 윈도우
    -   호핑 윈도우
    -   슬라이딩 윈도우
    -   세션 윈도우
-   텀블링 윈도우는 시간을 같은 크기의 겹치지 않는 구간으로 나누어서, 매분 발생한 클릭 이벤트를 집계하기에 적합함
-   슬랑이딩 윈도우는 미끄러져 나가면서, 데이터 스트림을 같은 시간 구간 안에 있는 이벤트를 집계. 서로 겹칠 수 있는 구간이 존재함.
-   전달 보장 방식
    -   최소 한 번
    -   최대 한 번
    -   적어도 한 번
    -   위와 같은 3가지 방법이 있고, 높은 정확도가 필요로 하는 시스템에서는 정확히 한 번이 필요
-   데이터 중복 제거
    -   클라이언트
        -   한 클라이언트가 같은 이벤트를 여러번 보내는 경우, 중복 이벤트를 제거하는 광고사기/위험 제거 컴포넌트가 필요
    -   서버
        -   같은 이벤트가 중복되지 않도록 분산 트랜잭션을 통해 처리 해야함
