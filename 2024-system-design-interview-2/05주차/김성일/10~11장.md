# 10. 실시간 게임 순위표

-   점수를 클라이언트에서 계산시 변조 문제 발생 가능 서버 계산 필요
-   게임 서비스와 순위표 서버 사이에 메시지 큐가 필요한지?
    -   게임 점수가 여러 곳 ( 순위표, 분석, 푸시 알림 등.. ) 에서 사용된다면 사용하는 것이 합리적
-   rdb 사용은 데이터가 많아지면 효과적이지 못함
-   레디스의 sorted set을 사용하는 것이 더 효율적
-   AWS의 API Gateway, AWS 람다의 두 가지 기술을 사용하면 규모 확장에도 좋음
-   레디스는 데이터를 샤딩하는 방안을 고려
    -   고정 파티션 방식
    -   해시 파티션 방식
    -   상위 N명을 검색하는 등의 방식이 해시 파티션 방식에서 까다롭기 때문에 고정 파티션을 사용하는 것이 유리
-   대안으로 NoSQL을 고려해볼 수 있음
-   레디스 클러스터 장애시 데이터베이스에 저장된 점수를 기반으로 복구하는 방식을 택하면 좋음



# 11. 결제 시스템

-   대금 수신 흐름
    -   구매자가 주문을 하면 전자상거래 사이트에 대금이 들어오는 것
-   대금 정산 흐름
    -   제품이 배송되고 나면 판매자에게 전자상거래 사이트가 대금을 지급하는 것
-   원장
    -   결제 트랜잭션에 대한 금융 기록
-   지갑
    -   판매자의 계정 잔액 기록
    -   결제 후 금액을 판매자의 지갑과 원장에 기록함
-   결제서비스는 일반적으로 ACID 트랜잭션을 지원하는 RDB를 선호
-   복식부기 원장
    -   구매자와 판매자의 결제 금액에 대한 차감과 증감에 대한 원장
    -   차감과 증감에 대한 합이 0원이 되어야 함
-   주문은 정확히 한 번만 등록할 수 잇도록 UUID로 결제 주문의 아이디를 만들어 사용
-   PSP는 결제 서비스에 토큰을 반환하고, 해당 토큰으로 결제 요청을하게 됨
-   조정 ( 일반적으로 대사를 의미하는 것 같음 )
    -   주기적으로 PSP의 결제 내역과 원장을 비교하는 것
-   결제 지연 처리
    -   가끔 PSP에서 결제 지연이 되는 경우가 있음. 이런 경우 웹훅 방식을 사용하여, 결제가 승인된 이후 주문이 완료되는 방식으로 구현.
-   내부 서비스 간의 커뮤니케이션
    -   타사 서비스 의존성이 높은 대규모 결제 시스템에는 비동기 통신이 더 나은 선택
-   결제 실패 처리
    -   복구 가능한 결제 실패라면 Retry-After등의 헤더와 함께 적절한 재시도 전략을 선택하고, 멱등성을 위해 멱등키를 사용하는 방식을 채택하면 좋음
-   비동기 시스템을 사용하게 되면 일관성을 맞추기 위해 합의 기반 분산 데이터베이스를 사용하는 것이 좋음
