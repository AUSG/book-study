# 12~13

# 12장. 전자지갑

결제기능과 지갑 간 이체가 가능해야 한다.

## 요구사항

- 전자 지갑 간 이체
- 높은 안정성과 높은 트랜잭션 처리
- 재현성

## API 설계

- 한 지갑에서 다른 지갑으로 자금 이체하는 API
- 돈의 경우 DB에 저장할 때 string으로 저장할 것

## 설계안

### 인메모리 기반 솔루션

- 레디스 사용
- 샤딩을 해서 많은 트랜잭션 처리를 감당한다.
- 주키퍼를 이용해서 어떤 샤드에 어떤 값을 저장했는지의 정보를 저장하기
- 하나의 원자적 트랜잭션으로 실행되지 못함

### 분산 트랜잭션

- DB 샤딩
- redis가 아닌 RDBMS로 변경
- 원자적 트랜잭션으로 하는 법
    - 2단계 커밋
    - TC/C
    - 사가

### 이벤트 소싱

- 재현성을 처리하기 위한 방법
- 4가지 중요한 것
    - 명령
    - 이벤트
    - 상태
    - 상태기계
- CQRS로 정보를 읽을 수 있도록 한다.
- 파일기반으로 명령/이벤트/상태를 관리
- 상태를 스냅숏으로 관리
- “합의”를 이용해 이벤트 처리를 누락하거나 지연되지 않도록 안정성을 높인다.

# 증권 거래소

## 요구사항

- 결함 내성
- 지연시간
- 보안
- 가용성

## 설계안

### 거래흐름

- 지연시간 요건이 엄격한 중요 경로이다.
- 핵심은 체결 엔진
    - 결정론적이어야 한다. → 시퀀서를 이용해 해결
        - id를 입출력하는 이유
            - 시의성과 공정성
            - 빠른복구 및 재생
            - 정확한 1회 실행 보증
- 주문 관리자
- 클라이언트 게이트웨이
    - 인증
    - 유효성검사
    - 처리율 제한
    - 정규화
    - FIXT 지원

### 시장 데이터 흐름

- 하나의 주문이 체결엔진부터 데이터서비스를 거쳐 브로커로 전달되기까지의 과정
- 시장데이터 게시 서비스는 호가창과 봉차트를 만든다.

### 보고 흐름

- 보고서비스는 거래이력, 세금보고, 규정준수 여부보고, 결산등의 기능을 제공
- 정확성과 규정준수가 핵심

## API 설계

- 주문 처리 API
- 집행정보 질의 API
- 호가창 주문서 질의 API
- 가격 변동 이력 질의 API

## 데이터 모델

- 상품, 주문 및 집행
- 호가 창/주문서
- 봉 차트

## 설계

### 성능

- 지연시간을 줄이는 방법
    - 중요 경로에서 실행할 작업 수 줄이기
    - 각 작업의 소요시간 줄이기
        - 네트워크, 디스크 사용량 경감
        - 작업의 실행시간 경감
- 이벤트 소싱
- 고가용성
    - 단일 장애지점 식별
    - 장애 감지및 빠른 조치
- 결함 내성
    - 카오스 엔지니어링 사용
- 체결 알고리즘
    - 다양한 알고리즘이 있어서 적절한 것을 사용
- 결정론
    - 기능적 결정론
    - 지연시간 결정론
        - P99지연시간 파악
- 시장 데이터 게시 서비스 최적화
    - 시장 데이터를 publish한다
    - 링 버퍼를 활용한다.
- 시장 데이터 공정한 배포
    - 멀티캐스트로 데이터를 전송한다.
- 코로케이션
    - 서버와 거래소를 물리적으로 가깝게 두는 것
- 네트워크 보안
    - DDoS 공격 고려하기