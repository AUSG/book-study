# 일관성과 합의

## 일관성 보장
복제 데이터베이스는 대부분 최소한 최종적 일관성을 제공
그러나 언제 복제본이 수렴될지는 아무것도 보장하지 않음

## 선형성
시스템에 데이터 복제본이 하나만 있으면 더 단순하지 않을까

최신 보장성

선형성 대 직렬성
- 직렬성 : 트랜잭션들의 격리 속성, 직렬성은 각 트랜잭션들이 어떤 순서에 따라 실행되는 것처럼 동작하도록 보장 
- 선형성 : 개별 객체에 실행되는 읽기와 쓰기에 대한 최신성 보장

## 선형성에 기대기
잠금과 리더 선출
- 단일 리더 복제 시스템은 리더가 하나만 존재하도록 보장해야 한다. 
- 이를 구현하는 한가지 방법은 잠금을 사용하는 것이고, 이는 어떻게 구현하든지 선형적이어야 한다.

제약 조건과 유일성 보장
- 유일성 보장 조건은 데이터베이스에서 흔하다.
- 이 제약 조건을 강제하고 싶다면 선형성이 필요하다.

채널 간 타이밍 의존성
- 선형성 보장이 없으면 두 채널 사이에 경쟁 조건이 발생할 수 있다.

## 선형성 시스템 구현하기
가장 간단한 해답은 데이터 복사본을 하나만 사용하는 것이다.
하지만 이 방법으로는 결함을 견뎌낼 수 없다.

단일 리더 복제
- 리더는 쓰기에 사용되는 데이터의 주 복사본을 갖고 있고 팔로워는 데이터의 백업 복사본을 보관한다.
- 리더나 동기식으로 갱신된 팔로워에서 실행한 읽니는 선형적이 될 가능성이 있다.
- 그러나 모든 단일 리더 데이터베이스가 선형적인 것은 아니다

합의 알고리즘
- 단일 리더 복제를 닮음
- 스플릿 브레인과 복제본이 뒤처지는 문제를 막을 수단이 포함
- 이런 세부 사항 덕에 선형성 저장소를 구현할 수 있다.

다중 리더 복제
- 일반적으로 선형적이지 않다.

리더 없는 복제
- 정족수 읽기와 쓰기로 일관성을 달성할수 있다고 주장
- 정족수의 설정에 따라, 엄격한 일관성을 어떻게 정의하느냐에 따라 다를 수 있다.


## 순서화 보장

선형성 레지스터는 데이터 복사본이 하나만 있는 것처럼 동작하고, 모든 연산이 어느 시점에 원자적으로 효과가 나타나는 것처럼 보인다고 했다.
이는 연산들이 잘 정의된 순서대로 실행 된다는 것을 암시한다.

### 순서화와 인과성

순서화는 인과성을 보존하는 데 도움을 준다.
인과성은 이벤트에 순서를 부여한다. 
이는 무엇이 무엇보다 먼저 일어났는가를 정의한다.
시스템이 인과성에 의해 부과된 순서를 지키면 그 시스템은 인과적으로 일관적 이다

선형성 vs 인과성
- 선형성 : 연산의 전체 순서를 정할 수 있다.
- 인과성 : 두 이벤트에 인과적인 관계가 있으면 순서가 있지만, 동시에 실행되면 비교할 수 없다. 전체 순서가 아닌 부분 순서를 정의한다. 어떤 연산들은 서로에 대해 순서를 정할 수 있지만 어떤 연산들은 비교할 수 없다

선형성은 인과성을 포함한다.
어떤 시스템이던지 선형적이라면 인과성도 올바르게 유지한다.
많은 경우에 선형성이 필요한 것처럼 보여도 사실 진짜 필요한 것은 인과적 일관성이다.

### 인과적 의존성 담기

인과성을 유지하기 위해 어떤 연산이 다른 연산보다 먼저 실행됐는지 알아야 한다.
전체 데이터베이스에 걸친 인과정 의존성을 추적해야 하고, 이를 위해 버전 벡터를 일반화해 사용한다

단일리더 시스템이라면, 일련번호나 타임스탬프를 써서 이벤트의 순서를 정할 수 있다.
이런 일련번호나 타임스탬프는 크기가 작고 전체 순서를 제공한다.
특히 인과성에 일관적인 전체 순서대로 일련번호를 생성할 수 있다.

단일리더가 아니라면, 위와 같은 방법이 가능해보이지않아 다른 여러 방법을 사용한다.
- 각 노드가 자신만의 독립적인 일련번호 집합을 생성한다
- 각 연산에 일 기준 시계 타임스탬프를 붙인다
- 일련번호 블록을 미리 할당한다
- 이런 방법들은 잘 동작하지만 생성한 일련번호가 인과성에 일관적이지 않다.

## 램포트 타임스탬프
## 전체 순서 브로드캐스트
두 가지 안전성 속성을 항상 만족해야 한다
- 신뢰성 있는 전달 : 어떤 메시지도 손실되지 않는다. 메시지가 한 노드에 전달되면 모든 노드에도 전달된다
- 전체 순서가 정해진 전달 : 메시지는 모든 노드에 같은 순서로 전달된다

노드나 네트워크에 결함이 있더라도 신뢰성과 순서화 속성이 항상 만족되도록 보장해야 한다.
전체 순서 브로드캐스트의 중요한 측면은 메시지가 전달되는 시점에 그 순서가 고정된다는 것이다.
이 사실 때문에 전체 순서 브로드캐스트가 타임스탬프 순서화보다 강하다.

## 분산 트랜잭션과 합의

합의는 분산 컴퓨팅에서 가장 중요하고 근본적인 문제중 하나다.
합의의 목적은 여러 노드들이 뭔가에 동의하게 만드는 것이고, 겉으로 보기에 간단해 보인다.
노드가 합의하는 것이 중요한 상황은 여러가지가 있다

- 리더 선출
- 원자적 커밋


### 원자적 커밋과 2단계 커밋